name: Proxy Checker Verified

on:
  schedule:
    - cron: '0 */6 * * *'  # 自动每6小时运行
  workflow_dispatch:       # 允许手动触发

jobs:
  verified-check:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Ubuntu environment
      run: |
        # 配置 Ubuntu 包源
        sudo tee /etc/apt/sources.list << EOL
        deb http://archive.ubuntu.com/ubuntu noble main restricted universe multiverse
        deb http://archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse
        deb http://security.ubuntu.com/ubuntu noble-security main restricted universe multiverse
        EOL

        sudo apt-get update
        sudo apt-get install -y \
          software-properties-common \
          apt-transport-https \
          curl \
          jq \
          unzip \
          python3 \
          python3-pip \
          netcat-openbsd \
          openssl \
          coreutils

    - name: Setup Python environment
      run: |
        python3 --version
        pip3 --version
        pip3 install pyyaml==6.0.1 requests

    - name: Install Hysteria2
      run: |
        sudo curl -fL -o /usr/local/bin/hysteria \
          "https://github.com/apernet/hysteria/releases/download/v2.0.4/hysteria-linux-amd64"
        sudo chmod +x /usr/local/bin/hysteria
        echo "Hysteria2 version: $(hysteria version)"

    - name: Install Xray-core
      run: |
        sudo curl -fL -o /tmp/xray.zip \
          "https://github.com/XTLS/Xray-core/releases/download/v1.8.11/Xray-linux-64.zip"
        sudo unzip -o /tmp/xray.zip -d /usr/local/bin/
        sudo chmod +x /usr/local/bin/xray
        echo "Xray version: $(xray version)"

    - name: Run checker with verification
      run: |
        # 强制生成初始文件
        echo "proxies:" > nodes.yml
        echo "# Speed test results" > speed.txt
        
        # 运行检查脚本
        python3 sub.py
        
        # 验证结果文件
        yamllint nodes.yml || echo "Warning: YAML lint failed"
        [ -s nodes.yml ] || echo "Warning: nodes.yml is empty"
        [ -s speed.txt ] || echo "Warning: speed.txt is empty"

    - name: Commit verified results
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Verified Update: $(date +'%Y-%m-%d %H:%M')"
        file_pattern: |
          nodes.yml
          speed.txt
        skip_fetch: true
        commit_user_name: "GitHub Bot"
        commit_user_email: "github-actions@example.com"
        allow_empty_commit: true

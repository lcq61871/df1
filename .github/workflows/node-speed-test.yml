# node-speed-test.yml
name: Proxy Checker Ultimate

on:
  schedule:
    - cron: '0 */6 * * *'  # 自动每6小时运行
  workflow_dispatch:       # 允许手动触发

jobs:
  verified-check:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Ubuntu environment
      run: |
        # 修复包源问题
        sudo tee /etc/apt/sources.list << EOL
        deb http://archive.ubuntu.com/ubuntu noble main restricted universe multiverse
        deb http://archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse
        deb http://security.ubuntu.com/ubuntu noble-security main restricted universe multiverse
        EOL

        sudo apt-get update
        sudo apt-get install -y \
          software-properties-common \
          apt-transport-https \
          curl \
          jq \
          unzip \
          python3 \
          python3-pip \
          netcat-openbsd \
          openssl \
          coreutils

    - name: Verify Python environment
      run: |
        python3 -m pip install --upgrade pip
        pip3 install pyyaml==6.0.1 requests

    - name: Install Hysteria2 (修正版)
      run: |
        HYSTERIA_VER=2.3.3  # 使用最新稳定版
        sudo curl -fL -o /usr/local/bin/hysteria \
          "https://github.com/apernet/hysteria/releases/download/v${HYSTERIA_VER}/hysteria-linux-amd64"
        sudo chmod +x /usr/local/bin/hysteria
        echo "Hysteria2 version: $(hysteria version)"

    - name: Install Xray-core (修正版)
      run: |
        XRAY_VER=1.8.11
        sudo curl -fL -o /tmp/xray.zip \
          "https://github.com/XTLS/Xray-core/releases/download/v${XRAY_VER}/Xray-linux-64.zip"
        sudo unzip -o /tmp/xray.zip -d /usr/local/bin/
        sudo chmod +x /usr/local/bin/xray
        echo "Xray version: $(xray version)"

    - name: Run checker with verification
      run: |
        # 初始化文件
        echo "proxies: []" > nodes.yml
        echo "# Speed Results" > speed.txt
        
        # 运行检查脚本
        python3 sub.py
        
        # 验证结果文件
        yamllint nodes.yml
        [ -s nodes.yml ] || exit 1
        [ -s speed.txt ] || exit 1

    - name: Commit verified results
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Auto Update: $(date +'%Y-%m-%d %H:%M')"
        file_pattern: |
          nodes.yml
          speed.txt
        skip_fetch: true
        allow_empty_commit: false

name: Proxy Checker Verified

on:
  schedule:
    - cron: '0 */6 * * *'  # 自动每6小时运行
  workflow_dispatch:       # 允许手动触发

jobs:
  verified-check:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 整个工作流最多运行 30 分钟
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Ubuntu environment
      run: |
        # 配置 Ubuntu 包源
        sudo tee /etc/apt/sources.list << EOL
        deb http://archive.ubuntu.com/ubuntu noble main restricted universe multiverse
        deb http://archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse
        deb http://security.ubuntu.com/ubuntu noble-security main restricted universe multiverse
        EOL

        sudo apt-get update
        sudo apt-get install -y \
          software-properties-common \
          apt-transport-https \
          curl \
          jq \
          unzip \
          python3 \
          python3-pip \
          netcat-openbsd \
          openssl \
          coreutils

    - name: Setup Python environment
      run: |
        python3 --version
        pip3 --version
        pip3 install pyyaml==6.0.1 requests

    - name: Install Hysteria2
      run: |
        HYSTERIA_URL="https://github.com/apernet/hysteria/releases/download/app%2Fv2.6.1/hysteria-linux-amd64"
        echo "正在下载 Hysteria2: ${HYSTERIA_URL}"
        for i in {1..3}; do
          if sudo curl -fL -o /usr/local/bin/hysteria "${HYSTERIA_URL}"; then
            break
          else
            echo "尝试 $i 失败，5秒后重试..."
            sleep 5
          fi
        done
        if [ ! -f /usr/local/bin/hysteria ]; then
          echo "错误：无法下载 Hysteria2，请检查链接。"
          exit 1
        fi
        sudo chmod +x /usr/local/bin/hysteria
        echo "Hysteria2 版本: $(hysteria version || echo '版本检查失败')"

    - name: Install Xray-core
      run: |
        XRAY_URL="https://github.com/XTLS/Xray-core/releases/download/v25.3.6/Xray-linux-64.zip"
        echo "正在下载 Xray-core: ${XRAY_URL}"
        for i in {1..3}; do
          if sudo curl -fL -o /tmp/xray.zip "${XRAY_URL}"; then
            break
          else
            echo "尝试 $i 失败，5秒后重试..."
            sleep 5
          fi
        done
        if [ ! -f /tmp/xray.zip ]; then
          echo "错误：无法下载 Xray-core，尝试使用官方安装脚本。"
          bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
          if [ ! -f /usr/local/bin/xray ]; then
            echo "错误：安装脚本无法安装 Xray-core。"
            exit 1
          fi
        else
          sudo unzip -o /tmp/xray.zip -d /usr/local/bin/
          sudo chmod +x /usr/local/bin/xray
        fi
        echo "Xray 版本: $(xray version || echo '版本检查失败')"

    - name: Run checker with verification
      timeout-minutes: 20  # 限制 sub.py 运行时间为 20 分钟
      run: |
        # 强制生成初始文件
        echo "proxies: []" > nodes.yml
        echo "# Speed test results" > speed.txt
        
        # 运行检查脚本
        python3 sub.py
        
        # 验证结果文件
        yamllint nodes.yml || echo "警告：YAML 格式检查失败"
        [ -s nodes.yml ] || echo "警告：nodes.yml 文件为空"
        [ -s speed.txt ] || echo "警告：speed.txt 文件为空"

    - name: Commit verified results
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Verified Update: $(date +'%Y-%m-%d %H:%M')"
        file_pattern: |
          nodes.yml
          speed.txt
        skip_fetch: true
        commit_user_name: "GitHub Bot"
        commit_user_email: "github-actions@example.com"

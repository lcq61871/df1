name: Proxy Checker Final

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Fix system dependencies
      run: |
        # 添加 Ubuntu 24.04 (Noble) 专属修复
        sudo apt-get update
        sudo apt-get install -y \
          software-properties-common \
          apt-transport-https

        # 添加必要仓库
        sudo add-apt-repository -y universe
        sudo add-apt-repository -y multiverse

    - name: Install network tools
      run: |
        # 修正包名
        sudo apt-get install -y \
          curl \
          jq \
          unzip \
          python3-full \  # 替代 python3 + python3-pip
          netcat-openbsd \  # 确认包名正确性
          openssl \
          coreutils

    - name: Install Python packages
      run: |
        python3 -m ensurepip --upgrade
        python3 -m pip install pyyaml==6.0.1

    - name: Install Hysteria2
      run: |
        # 使用静态编译版本
        sudo curl -fL -o /usr/local/bin/hysteria \
          "https://github.com/apernet/hysteria/releases/latest/download/hysteria-linux-amd64"
        sudo chmod +x /usr/local/bin/hysteria

    - name: Install Xray-core
      run: |
        sudo curl -fL -o /usr/local/bin/xray \
          "https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64"
        sudo chmod +x /usr/local/bin/xray

    - name: Run checker
      run: python3 sub.py

    - name: Commit results
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Auto Update: $(date +'%Y-%m-%d %H:%M')"
        file_pattern: |
          nodes.yml
          speed.txt

name: Advanced Node Test

on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时运行
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          curl \
          netcat-openbsd \
          python3 \
          python3-pip \
          jq \
          socat

        # 使用sudo安装Xray
        sudo bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
        
        # 验证安装
        /usr/local/bin/xray -version || echo "Xray安装验证失败"

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Python dependencies
      run: pip install pyyaml

    - name: Run tester
      run: |
        chmod +x sub.py
        python3 sub.py

    - name: Verify results
      run: |
        echo "=== 测试结果 ==="
        ls -l output/
        [ -f output/nodes.yml ] && echo "nodes.yml存在" || echo "nodes.yml不存在"
        [ -f output/speed.txt ] && echo "speed.txt存在" || echo "speed.txt不存在"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: node-results
        path: output/
        retention-days: 3

    - name: Commit results
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "自动更新节点测试结果 [skip ci]"
        file_pattern: |
          output/nodes.yml
          output/speed.txt
